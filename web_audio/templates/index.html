<html>
    <head>
    </head>
    <body><script
        src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
            
        <script>
            // Open socket 
            socket = new WebSocket('ws://localhost:5000/ws');
            socket.onopen = function(event) {$('#log').append('<p>Connection established.</p>');};
            socket.onclose = function(event) {$('#log').append('<p>Connection closed.</p>');};
            socket.onerror = function(event) {$('#log').append('<p>Error: [' + event.message + '].</p>');};
            
            window.addEventListener("unload", function () {
                if(socket && socket.readyState == WebSocket.OPEN)
                    socket.close(1000);
            });
            
            class WSSourceNode extends AudioWorkletNode{
                constructor(ws){
                    super(audioCtx, 'ws-receiver');
                    this.socket = ws;
                    var p = this.port;
                    // When I receive data from the socket
                    this.socket.onmessage = function(event) {
                        event.data.arrayBuffer().then(function(d){
                            d = new Uint8Array( d );
                            p.postMessage(d);
                        });
                    };
                }
            }
            class WSSinkNode extends AudioWorkletNode{
                constructor(ws){
                    super(audioCtx, 'ws-sender');
                    this.socket = ws;
                    // When I receive data from the processor
                    this.port.addEventListener('message', (event) => {
                        this.ondata(event);
                    });
                    this.port.start();
                }
                ondata(event){
                    //console.log(event);
                    this.socket.send(event['data']);
                }
            }
            const SAMPLE_RATE=4000;
            var audioCtx = null;
            var wssource = null;
            var micsource = null;
            var wssink = null;
            async function play(){
                if (audioCtx==null){
                    audioCtx = new AudioContext({'sampleRate':SAMPLE_RATE});
                    await audioCtx.audioWorklet.addModule('static/wsworklet.js');
                }
                if(wssource==null){
                    wssource = new WSSourceNode(socket);
                }
                wssource.connect(audioCtx.destination);
            };
            async function stop(){
                if(wssource){
                    try{
                        wssource.disconnect(audioCtx.destination);
                    }catch (DOMException){
                        console.log("Already disconnected SPEAKER?");
                    }
                }
                if(micsource){
                    try{
                        micsource.disconnect(wssink);
                    }catch (DOMException){
                        console.log("Already disconnected MIC?");
                    }
                }
            };
            async function rec(){
                if (audioCtx==null){
                    audioCtx = new AudioContext({'sampleRate':SAMPLE_RATE});
                    await audioCtx.audioWorklet.addModule('static/wsworklet.js');
                }
                stream = await navigator.mediaDevices.getUserMedia({audio: true, video:false});
                micsource = audioCtx.createMediaStreamSource(stream);
                //micsource.connect(audioCtx.destination);
                if(wssink==null){
                    wssink = new WSSinkNode(socket);
                }
                micsource.connect(wssink);
            }

        </script>

        <button onClick="play()">PLAY</button>
        <button onClick="rec()">REC</button>
        <button onClick="stop()">STOP</button>
        <div id="log">
            
        </div>
    </body>
</html>
